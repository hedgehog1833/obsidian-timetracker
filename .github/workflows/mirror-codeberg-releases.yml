name: Mirror latest tag from Codeberg & create release

permissions:
  contents: write

on:
  workflow_dispatch:
  repository_dispatch:

jobs:
  fetch-tags:
    runs-on: ubuntu-latest
    outputs:
      github_tag: ${{ steps.get_github_tag.outputs.tag }}
      codeberg_tag: ${{ steps.get_codeberg_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          fetch-depth: 0

      - name: Get latest github tag
        id: get_github_tag
        run: |
          echo "tag=$(git tag --list --sort=-creatordate | head -n 1)" >> $GITHUB_OUTPUT

      - name: Add Codeberg remote and fetch tags
        env:
          CODEBERG_URL: https://codeberg.org/hedgehog1833/obsidian-timetracker.git
        run: |
          git remote add codeberg "$CODEBERG_URL" || true
          git fetch codeberg --tags --prune

      - name: Push tags to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} --tags

      - name: Get latest Codeberg tag
        id: get_codeberg_tag
        run: |
          echo "tag=$(git tag --list --sort=-creatordate | head -n 1)" >> $GITHUB_OUTPUT
  release:
    needs: fetch-tags
    if: needs.fetch-tags.outputs.codeberg_tag != needs.fetch-tags.outputs.github_tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          fetch-depth: 0

      - name: Checkout latest tag
        run: |
          echo "Checking out tag ${{ needs.fetch-tags.outputs.codeberg_tag }}"
          git checkout -f "refs/tags/${{ needs.fetch-tags.outputs.codeberg_tag }}"
          git clean -fdx

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # 6.2.0
        with:
          node-version: 24

      - name: Build assets
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build
          else
            echo "No package.json found, aborting."
            exit 1
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # 2.5.0
        with:
          name: ${{ needs.fetch-tags.outputs.codeberg_tag }}
          tag_name: ${{ needs.fetch-tags.outputs.codeberg_tag }}
          body: "Mirror release for tag ${{ needs.fetch-tags.outputs.codeberg_tag }} from [Codeberg](https://codeberg.org/hedgehog1833/obsidian-timetracker/releases/tag/${{ needs.fetch-tags.outputs.codeberg_tag }})."
          files: |
            main.js
            manifest.json
            styles.css

      - name: Update manifest and versions on main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git checkout main
          git pull
          git checkout "refs/tags/${{ needs.fetch-tags.outputs.codeberg_tag }}" -- manifest.json versions.json
          git add manifest.json versions.json
          git commit -m "chore(release): update manifest.json and versions.json from tag ${{ needs.fetch-tags.outputs.codeberg_tag }}"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} main
